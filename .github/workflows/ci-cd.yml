# çŸ¿åŒºå®‰å…¨æ•°æ®åº“å‰ç«¯ - CI/CDè‡ªåŠ¨åŒ–éƒ¨ç½²å·¥ä½œæµ
# 
# å·¥ä½œæµç¨‹ï¼š
# 1. ä»£ç æŽ¨é€åˆ°mainåˆ†æ”¯ â†’ è§¦å‘æž„å»º
# 2. æž„å»ºReactåº”ç”¨å’ŒDockeré•œåƒ
# 3. æŽ¨é€é•œåƒåˆ°GitHub Container Registry
# 4. é€šçŸ¥æœåŠ¡å™¨è‡ªåŠ¨æ‹‰å–æœ€æ–°é•œåƒ

name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'Dockerfile'
      - 'docker/**'
  pull_request:
    branches: [ main, master ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: mining-safety-db-frontend

jobs:
  # ================================
  # æž„å»ºå’Œæµ‹è¯•é˜¶æ®µ
  # ================================
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ“¦ è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ðŸ”§ å®‰è£…ä¾èµ–
      run: |
        npm ci --no-audit --no-fund
    
    - name: ðŸ§¹ ä»£ç è§„èŒƒæ£€æŸ¥
      run: |
        npm run lint
    
    - name: ðŸ“Š TypeScriptç±»åž‹æ£€æŸ¥
      run: |
        npx tsc --noEmit
    
    - name: ðŸ—ï¸ æž„å»ºåº”ç”¨
      run: |
        npm run build
      env:
        REACT_APP_API_BASE_URL: https://mining-backend.ziven.site/api
        REACT_APP_SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        CI: false
    
    - name: ðŸ“ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: build/
        retention-days: 7

  # ================================
  # Dockeré•œåƒæž„å»ºå’ŒæŽ¨é€
  # ================================
  docker-build-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ” ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ·ï¸ æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
        tags: |
          # åˆ†æ”¯åæ ‡ç­¾
          type=ref,event=branch
          # PRæ ‡ç­¾
          type=ref,event=pr
          # è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          # æœ€æ–°æ ‡ç­¾ï¼ˆä»…é™mainåˆ†æ”¯ï¼‰
          type=raw,value=latest,enable={{is_default_branch}}
          # æ—¶é—´æˆ³æ ‡ç­¾
          type=raw,value={{date 'YYYYMMDD-HHmmss' tz='Asia/Shanghai'}}
        labels: |
          org.opencontainers.image.title=Mining Safety DB Frontend
          org.opencontainers.image.description=çŸ¿åŒºè¯­è¨€å®‰å…¨æ•°æ®åº“å‰ç«¯åº”ç”¨
          org.opencontainers.image.vendor=Mining Safety DB Team
    
    - name: ðŸ—ï¸ æž„å»ºå¹¶æŽ¨é€Dockeré•œåƒ
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          REACT_APP_API_BASE_URL=https://mining-backend.ziven.site/api
          REACT_APP_SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY }}
          BUILD_VERSION=${{ github.sha }}
          BUILD_DATE=${{ steps.meta.outputs.labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ github.sha }}
    
    - name: ðŸ“ é•œåƒæž„å»ºæ‘˜è¦
      run: |
        echo "### ðŸ³ Dockeré•œåƒæž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "**é•œåƒæ ‡ç­¾**: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**é•œåƒæ‘˜è¦**: \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**æ”¯æŒå¹³å°**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY

  # ================================
  # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²é€šçŸ¥
  # ================================
  notify-deployment:
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¤ å‘é€éƒ¨ç½²é€šçŸ¥
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.DEPLOY_TOKEN || secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        event-type: deployment-ready
        client-payload: |
          {
            "image_tag": "${{ needs.docker-build-push.outputs.image-tag }}",
            "image_digest": "${{ needs.docker-build-push.outputs.image-digest }}",
            "git_sha": "${{ github.sha }}",
            "environment": "production"
          }
    
    - name: ðŸ“‹ éƒ¨ç½²ä¿¡æ¯æ‘˜è¦
      run: |
        echo "### ðŸš€ éƒ¨ç½²é€šçŸ¥å·²å‘é€" >> $GITHUB_STEP_SUMMARY
        echo "**çŽ¯å¢ƒ**: ç”Ÿäº§çŽ¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
        echo "**é•œåƒ**: \`${{ needs.docker-build-push.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æœåŠ¡å™¨ç®¡ç†å‘˜å¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ›´æ–°ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/server-update.sh | bash -s -- ${{ needs.docker-build-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ================================
  # å®‰å…¨æ‰«æ (å¯é€‰)
  # ================================
  security-scan:
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: ðŸ” è¿è¡ŒTrivyæ¼æ´žæ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ needs.docker-build-push.outputs.image-tag }}
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: ðŸ“Š ä¸Šä¼ æ‰«æç»“æžœåˆ°GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: ðŸ“ å®‰å…¨æ‰«ææ‘˜è¦
      run: |
        echo "### ðŸ”’ å®‰å…¨æ‰«æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "æ‰«æç»“æžœå·²ä¸Šä¼ åˆ°GitHub Securityæ ‡ç­¾é¡µ" >> $GITHUB_STEP_SUMMARY