# 聊天历史存储方案

## 概述

本方案设计了一个完整的聊天历史存储系统，支持用户独立的聊天会话管理。AI对话请求直接从前端发送到第三方AI服务，后端只负责存储和管理聊天历史记录。

## 架构设计

### 前端架构
```
前端应用
├── AI聊天界面 (NewAIChat.tsx)
├── 聊天存储服务 (chatHistory.ts)
├── 状态管理 (chatStore.ts)
└── 直接调用AI服务 (siliconflow.ts)
```

### 后端架构
```
后端API
├── 会话管理 (/api/chat/sessions)
├── 消息存储 (/api/chat/sessions/{id}/messages)
├── 用户认证 (JWT)
└── 数据库存储 (MySQL)
```

## 数据库设计

### 1. 聊天会话表 (chat_sessions)
```sql
CREATE TABLE chat_sessions (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    title VARCHAR(200) NOT NULL DEFAULT '新对话',
    description TEXT,
    status ENUM('active', 'archived', 'deleted') DEFAULT 'active',
    message_count INT DEFAULT 0,
    total_tokens INT DEFAULT 0,
    last_message_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_last_message (last_message_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 2. 聊天消息表 (chat_messages)
```sql
CREATE TABLE chat_messages (
    id VARCHAR(36) PRIMARY KEY,
    session_id VARCHAR(36) NOT NULL,
    role ENUM('user', 'assistant', 'system') NOT NULL,
    content TEXT NOT NULL,
    tokens_used INT DEFAULT 0,
    model_name VARCHAR(50),
    response_time DECIMAL(5,3),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_session_id (session_id),
    INDEX idx_session_created (session_id, created_at),
    FOREIGN KEY (session_id) REFERENCES chat_sessions(id) ON DELETE CASCADE
);
```

### 3. 消息反馈表 (chat_message_feedback)
```sql
CREATE TABLE chat_message_feedback (
    id VARCHAR(36) PRIMARY KEY,
    message_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    feedback_type ENUM('like', 'dislike', 'report') NOT NULL,
    feedback_reason VARCHAR(100),
    feedback_comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (message_id) REFERENCES chat_messages(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_message (user_id, message_id)
);
```

## API接口设计

### 会话管理
- `POST /api/chat/sessions` - 创建会话
- `GET /api/chat/sessions` - 获取会话列表
- `GET /api/chat/sessions/{id}` - 获取会话详情
- `PUT /api/chat/sessions/{id}` - 更新会话
- `DELETE /api/chat/sessions/{id}` - 删除会话
- `PUT /api/chat/sessions/{id}/archive` - 归档会话

### 消息管理
- `POST /api/chat/sessions/{id}/messages` - 保存消息
- `GET /api/chat/sessions/{id}/messages` - 获取消息历史
- `DELETE /api/chat/messages/{id}` - 删除消息
- `DELETE /api/chat/sessions/{id}/messages` - 批量删除消息
- `DELETE /api/chat/sessions/{id}/messages/all` - 清空会话

### 反馈管理
- `POST /api/chat/messages/{id}/feedback` - 提交反馈

## 前端实现

### 1. 聊天历史服务 (chatHistory.ts)
提供与后端API交互的方法：
- 会话CRUD操作
- 消息保存和查询
- 反馈提交

### 2. 状态管理 (chatStore.ts)
使用Zustand管理聊天状态：
- 本地状态管理
- 后端数据同步
- 持久化存储

### 3. 聊天界面 (NewAIChat.tsx)
集成历史记录功能：
- 会话列表显示
- 消息历史加载
- 实时AI对话

## 工作流程

### 1. 用户发送消息
```
1. 用户输入消息
2. 前端创建用户消息对象
3. 直接调用AI服务获取响应
4. 处理AI流式响应
5. 将用户消息和AI响应保存到后端
6. 更新本地状态
```

### 2. 会话管理
```
1. 用户创建新会话 -> 调用后端API创建
2. 切换会话 -> 从后端加载消息历史
3. 删除会话 -> 调用后端API删除
4. 更新会话标题 -> 调用后端API更新
```

### 3. 数据同步
```
1. 应用启动 -> 从后端加载会话列表
2. 切换会话 -> 加载该会话的消息历史
3. 发送消息 -> 实时保存到后端
4. 离线操作 -> 本地缓存，联网后同步
```

## 特性

### 1. 用户隔离
- 每个用户只能访问自己的聊天记录
- 基于JWT认证的权限控制
- 数据库级别的用户隔离

### 2. 性能优化
- 分页加载消息历史
- 本地状态缓存
- 懒加载会话内容

### 3. 数据安全
- 敏感信息加密存储
- 定期数据清理
- 备份和恢复机制

### 4. 扩展性
- 支持多种AI模型
- 插件化反馈系统
- 可配置的存储策略

## 部署说明

### 1. 数据库初始化
```sql
-- 执行建表脚本
-- 创建索引
-- 插入初始数据
```

### 2. 后端配置
```bash
# 环境变量
DB_HOST=localhost
DB_NAME=mining_safety_db
JWT_SECRET=your-secret-key
```

### 3. 前端配置
```typescript
// API基础URL配置
const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001';
```

## 监控和维护

### 1. 性能监控
- API响应时间
- 数据库查询性能
- 存储空间使用

### 2. 数据维护
- 定期清理过期会话
- 压缩历史消息
- 备份重要数据

### 3. 用户体验
- 错误处理和重试
- 离线支持
- 响应式设计

## 总结

本方案提供了一个完整的聊天历史存储解决方案，支持：
- 用户独立的聊天空间
- 实时AI对话和历史记录
- 可扩展的架构设计
- 良好的用户体验

通过前后端分离的架构，确保了系统的可维护性和扩展性，同时保证了数据的安全性和用户体验。
